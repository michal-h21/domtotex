<!DOCTYPE html>
<html><head>
<meta charset="utf-8" />
<style type="text/css">
	#result{
		border:1px dashed gray;
		font-size:70%;
	}
	#result p{
		background-color:#f0f0f0;
		margin:0;
		margin-bottom:2px;
		white-space:pre;
	}
.hidden, math annotation{display:none;}
</style>

<script type="text/javascript" src="mustache.js"></script>
<script type="text/javascript" src="domtotex.js"></script>

<script type="text/javascript">
	var latexEscape = Domtotex.latexEscape;
	var getStyle = Domtotex.getStyle;

	// function from https://gist.github.com/cms/369133

var templates = {
  "h1": [
  {
    "selector": "*",
    "template": '\\section{<<content>>}'
  }],
  "i" : [
  {
   "selector": "*",
   "template": "\\textit{<<content>>}"
  }
  ],
  "b": [{
   "selector": "*",
   "template": "\\textbf{<<content>>}"
  }],
  "math": [{
    "selector": "[mode='display']",
    "template": "\\[<<content>>\\]"
  },{
    "selector": "*",
    "template": "$<<content>>$" 
  }],
  "mfrac": [{
   "selector" :"*",
	 "template": "\\frac{<<>first>>}{<<>second>>}"
	}],
	"msqrt": [{
		"selector": "*",
		"template": "\\sqrt{<<content>>}"
	}],
	"msup": [{
		"selector": "*",
		"template": "<<>first>>^<<>second>>"
	}],
	"a": [{
		"template": "<<#link>><<#attr>>href<</attr>><</link>>{<<content>>}",
		"selector": "*",
		"packages": ["hyperref"]
	}],
  "*default": [{
    "selector": "*",
    "template": "<<content>>"
  }
  ]
}	

Textpl.loadTemplates(templates);
function reduceSpaces(t){
	return t.replace(/^\s+|\s+$/g, ' ');
}

 
//var getTemplate = Textpl.getTemplate;

function getText(element) {
    var text = [];
		//var template = getTemplate(element);
		var myvariables = {}//variables;
		var display = getStyle(element,'display');
		if(display =='none') return '';
		var myescape = latexEscape;
    //log(name+": "+ template);
    for (var i= 0, n= element.childNodes.length; i<n; i++) {
        var child= element.childNodes[i];
        if (child.nodeType===1 && child.tagName.toLowerCase()!=='script')
            text.push(getText(child));
        else if (child.nodeType===3)
            text.push(myescape(reduceSpaces(child.data)));
    }
    myvariables["content"] =  text.join('');
    myvariables["element"] = element;
    if(display=='block')
      return "\n" + Textpl.render(element, myvariables) + "\n";
    else
      return Textpl.render(element, myvariables) ;
}


</script>
</head>
<body>
	<article> 
	<h1>Nadpis</h1>
	<p><i>Hello</i> <b>world</b>. Zvláští \ $ % znaky ~. Co třeba <a href="#nadpis">odkaz?</a></p>
	<p>
<math xmlns="http://www.w3.org/1998/Math/MathML">
      <mrow>
        <msup><mi>a</mi><mn>2</mn></msup>
        <mo>+</mo>
        <msup><mi>b</mi><mn>2</mn></msup>
        <mo>=</mo>
        <msup><mi>c</mi><mn>2</mn></msup>
      </mrow>
    </math>
		<span class="hidden">Skrytej text</span>. <a href="http://tex.stackexchange.com">tex.sx</a>.
</p>
<math mode="display" xmlns="http://www.w3.org/1998/Math/MathML">
  <mrow>
    <mi>x</mi>
    <mo>=</mo>
    <mfrac>
      <mrow>
        <mo form="prefix">&#x2212;<!-- − --></mo>
        <mi>b</mi>
        <mo>&#x00B1;<!-- &PlusMinus; --></mo>
        <msqrt>
          <msup>
            <mi>b</mi>
            <mn>2</mn>
          </msup>
          <mo>&#x2212;<!-- − --></mo>
          <mn>4</mn>
          <mo>&#x2062;<!-- &InvisibleTimes; --></mo>
          <mi>a</mi>
          <mo>&#x2062;<!-- &InvisibleTimes; --></mo>
          <mi>c</mi>
        </msqrt>
      </mrow>
      <mrow>
        <mn>2</mn>
        <mo>&#x2062;<!-- &InvisibleTimes; --></mo>
        <mi>a</mi>
      </mrow>
    </mfrac>
  </mrow>
  <annotation encoding="TeX">
     x=\frac{-b\pm\sqrt{b^2-4ac}}{2a}
  </annotation>
  <annotation encoding="StarMath 5.0">
     x={-b plusminus sqrt {b^2 - 4 ac}} over {2 a}
  </annotation>
</math>
	</article>
	<div id="result">

	</div>
</body>

<script type="text/javascript">
	log = function(t) {
		var hlaska = document.createElement("p");
		hlaska.innerHTML = t;
		var result = document.querySelector("#result")
		result.appendChild(hlaska);
	}
	var el = Domtotex.select("article")//document.querySelector();
	log(latexEscape("\\textit{pokus % ~ ^ $ }"))
  log("display: "+ getStyle(el,'display'));
	var i = document.querySelector("i")
  //var matches = Domtotex.matches;
  //var x = matches(i,"p i")
	//log("match: "+x);
  log(getText(el))
	//log(pokus.ahoj("ff").ahoj("world").print())
	
</script>
</html>
